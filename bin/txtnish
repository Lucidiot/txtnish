#!/bin/sh

TAB=$(printf "\t")
limit=20
formatter="fmt"

die () {
	printf "$0: %s\n" "$1"
	exit "${2:-1}"
}

create_dir () {
	[ -d "$1" ] || mkdir -p "$1"
}

read_config () {
	if [ -e ~/.config/txtnish/config ];then
		. ~/.config/txtnish/config
	fi
}

update () {
	create_dir ~/.cache/txtnish/
	urls | xargs -n1 -P20 wget --timestamping -P ~/.cache/txtnish/ -x -q
}

urls () {
	[ -f ~/.config/txtnish/following ] || return
	## i'm not using awk here as the number of urls is usually pretty short.
	while read _ url;do
		printf "%s\n" "$url"
	done < ~/.config/txtnish/following
}

format_msg () {
	while read nick url ts msg;do
		printf "* %s (%s)\n" "$nick" "$ts"
		if type "$formatter" >/dev/null 2>&1;then
			printf "%s\n" "$msg" | $formatter
		else
			printf "%s\n" "$msg"
		fi
		printf "\n"
	done
}

limit () {
	if [ -n "$limit" ];then
		sed "${limit}q"
	else
		cat
	fi
}

sort_tweets () {
	awk -F"$TAB" '
		BEGIN { OFS=FS; OFMT="%f" }
		$3 && $4 {
			ts=$3
			sub(/Z$/,"+00:00",ts)
			no_fields = split(ts,ta,/[T:+.-]/)
			seconds = (ta[1]-1970)*31557600 + ta[2] * 2628000 + ta[3] * 86400 + ta[4] * 3600 + ta[5] * 60 + ta[6]
			if ( no_fields == 9 ) {
				offset = ta[8] * 3600 + ta[9] * 60
				fracsecs=ta[7]
			}
			else {
				offset = ta[7] * 3600 + ta[8] * 60
				fracsecs=0
			}
			mod = substr(ts,length(ts)-5,1)
			if ( mod == "+" ) {
				seconds += offset
			} else {
				seconds -= offset
			}
			print seconds, fracsecs, $0
		}	
	' | sort -nr -k1,2 | cut -d "$TAB" -f 3-
}

	else
		cat
	fi
}

timeline () {
	update;
	while read nick url;do
		twtfile=~/.cache/txtnish/${url#*://}
		twtfile=${twtfile%%#*}
		if [ -d "$twtfile" ] && [ -e "$twtfile/index.html" ];then
			twtfile="$twtfile/index.html"
		fi
		[ -e "$twtfile" ] || continue

		awk -vnick="$nick" -vurl="$url" 'BEGIN{OFS="\t"}{print nick,url,$0}' < "$twtfile"
	done < ~/.config/txtnish/following | sort_tweets | limit | format_msg
}


mode=$1
shift

read_config

case $mode in
	update ) update ;;
	timeline ) timeline ;;
	* ) die "Unknown mode $mode." ;;
esac

exit 0
