#!/bin/sh

VERSION="0.2"

TAB=$(printf "\t")

###################
## Default config #
###################

limit=20
formatter="fmt"
use_pager=1
use_color=1
always_update=1
sort_order=descending
twtfile=~/twtxt.txt
disclose_identity=0
max_procs=20
xargs_parallel=1
editor=${EDITOR:-vi}
pager=${PAGER:-less -R}
color_nick=yellow
color_time=blue
color_hashtag=cyan
color_mention=yellow
sign_twtfile=0
check_signatures=0
ipfs_publish=0
ipfs_wrap_with_dir=0
ipfs_recursive=0
ipfs_gateway=http://localhost:8080
nick="${USER}"

######################
## Runtime variables #
######################

program_name=${0##*/}
config_dir="${XDG_CONFIG_HOME:-$HOME/.config}/txtnish"
config_file="$config_dir/config"
follow_file="$config_dir/following"
draft_file="$config_dir/draft"
cache_dir="${XDG_CACHE_HOME:-$HOME/.cache}/txtnish"
log_dir="$cache_dir/logs"

#####################
## Helper Functions #
#####################

# Description: Check if command is in path
# Synopsis: have_cmd COMMAND
# Returns: success if command is found; fails otherwise

have_cmd () {
	command -v "$1" >/dev/null 2>&1
}

# Description: Print error message and exit
# Synopsis: die MESSAGE RETURN_CODE
# Returns: nothing

die () {
	printf "%s: %s\n" "$program_name" "$1" >&2
	exit "${2:-1}"
}

# Description: Create dir unless it exists
# Synopsis: create_dir DIR
# Returns: nothing

create_dir () {
	[ -d "$1" ] || mkdir -p "$1"
}

# Description: Source configuration file if it exists
# Synopsis: read_config
# Returns: nothing

read_config () {
	if [ -e "$config_file" ];then
		. "$config_file"
	fi
}

# Description: Print arguments for curl on stdout for xargs
# Synopsis: args_for_curl NICK URL COUNTER
# Returns: Nothing

args_for_curl () {
	printf "%s\n" \
		--user-agent "$user_agent" \
		--location \
		--stderr "$log_dir/http.log.$1" \
		--show-error \
		--silent \
		--output "$cache_dir/twtfiles/$1.txt" \
		--time-cond "$cache_dir/twtfiles/$1" \
		--write-out '%{filename_effective}\t%{http_code}\t%{num_redirects}\t%{url_effective}\n' \
		"$2"
}


rewrite_url () {
	if [ -z "$_ipfs_checked" ];then
		if ! curl -s "$ipfs_gateway" > /dev/null 2>&1 ;then
			ipfs_gateway=https://ipfs.io
		fi
		_ipfs_checked=1
	fi

	case $url in
		ipns://* )
			url=$ipfs_gateway/ipns/${url#ipns://}
		;;
	esac
}

maybe_update () {
	if [ "$always_update" -eq 1 ];then
		update
	fi
}

format_msg (){
	if ! have_cmd "$formatter" ;then
		formatter=cat
	fi
	export color_nick color_time color_hashtag color_mention use_color formatter
	awk '
		BEGIN {
			FS="\t"
			ORS="\n\n"
			csi = "\033["
			reset = csi "0m"
			fg = 3
			bg = 4
			colors["black"] = 0
			colors["red"] = 1
			colors["green"] = 2
			colors["yellow"] = 3
			colors["blue"] = 4
			colors["magenta"] = 5
			colors["cyan"] = 6
			colors["white"] = 7
			srand()
			now=srand()
		}

		function colorize ( layer, color, text ) {
			return csi layer colors[color] "m" text reset
		}

	{
		nick=$1;url=$2;props=$3;ts=$4;msg=$5
		seconds=now-ts
		if ( seconds >  86400 ) {
			ts = int(seconds / 86400) " days ago"
		} else if ( seconds > 3600 ) {
			ts = int(seconds / 3600) " hours ago"
		} else if ( seconds > 60 ) {
			ts = int(seconds / 60) " minutes ago"
		} else {
			ts = seconds " seconds ago"
		}

		if ( ENVIRON["use_color"] == 1 ) {
			n = split(props,prop_array,/,/)
			props=""
			for ( i in prop_array ) {
				if ( prop_array[i] == "tls" || prop_array[i] == "gpg_trusted" ) {
					prop_array[i] = colorize(fg,"green",prop_array[i])
				}
				if ( prop_array[i] == "notls" ) {
					prop_array[i] = colorize(fg,"red",prop_array[i])
				}
			}

			props = prop_array[1]
			for (i = 2; i <= n; i++)
				props = props "," prop_array[i]

			nick = csi fg colors[ENVIRON["color_nick"]] "m" nick reset
			ts = csi fg colors[ENVIRON["color_time"]] "m" ts reset
			gsub(/#[[:alnum:]_]+/, csi fg colors[ENVIRON["color_hashtag"]] "m&" reset, msg)
			gsub(/@[[:alnum:]_]+/, csi fg colors[ENVIRON["color_mention"]] "m&" reset, msg)
		}
		fmt = ENVIRON["formatter"]
		printf "* %s (%s)", nick, ts
		if ( props )  printf " [%s]", props
		printf "\n"
		print msg | fmt
		close(fmt)
	}'
}

limit () {
	if [ "$limit" -gt 0 ];then
		sed "${limit}q"
	else
		cat
	fi
}

sort_tweets () {
	case $sort_order in
		ascending  ) _sort_switches="" ;;
		descending ) _sort_switches=-r ;;
		* ) die "Sort order must be either ascending or descending." ;;
	esac

	awk '
		BEGIN {
			OFS=FS="\t";
			srand()
			now = srand()
		}
		{
			ts=$4
			no_fields = split(ts,ta,/[Tt:+.-]/)
			year = ta[1]; month  = ta[2]; day     = ta[3]
			hour = ta[4]; minute = ta[5]; seconds = ta[6]

			if ( no_fields == 9 ) {
				offset = ta[8] * 3600 + ta[9] * 60
				fracsecs=ta[7]
			}
			else {
				offset = ta[7] * 3600 + ta[8] * 60
				fracsecs=0
			}
			epoch_days = 719591

			if ( month > 2 ) {
				month++
			} else {
				year--
				month+=13
			}
			tweet_days = (year*365)+int(year/4)-int(year/100)+int(year/400) + int(month*30.6)+ day

			days_since_epoch = tweet_days - epoch_days

			seconds_since_epoch = (days_since_epoch*86400)+(hour*3600)+(minute*60)+seconds

			mod = substr(ts,length(ts)-5,1)
			if ( mod == "+" ) {
				seconds_since_epoch -= offset
			} else {
				seconds_since_epoch += offset
			}
			$4 = seconds_since_epoch

			if ( $4 <= now )
				print fracsecs, $0
		}
	' | sort -rn -k5 -k1 -t "$TAB" | uniq_tweets | limit | sort -n $_sort_switches -k5 -k1 -t "$TAB" | cut -f 2-
}

uniq_tweets () {
	awk '
		BEGIN {
			FS=OFS="\t"
		}
		{
			key = $1 $5 $6
			if ( last != key )
				print
			last = key
		}
	'
}

maybe_pager () {
	if [ "$use_pager" -eq 1 ];then
		$pager
	else
		cat
	fi
}

in_list () {
	case " $1 " in
		*\ $2\ * ) return 0 ;;
		* ) return 1 ;;
	esac
}

prefix_columns () {
	awk -vnick="$1" -vurl="$2" -vprops="$3" 'BEGIN{OFS="\t"}{print nick,url,props,$0}'
}

filter_tweets () {
	filter_expr="${filter_expr:-1}"
	awk -F"\t" '{nick=$1;url=$2;props=$3;ts=$4;msg=$5; if ('"$filter_expr"') { print } }'
}

display_tweets () {
	normalize_tweets | filter_tweets | sort_tweets | collapse_mentions | format_msg | maybe_pager
}

normalize_tweets () {
	awk '
		BEGIN{
			FS=OFS="\t"
			rfc3339 = "^([0-9]+)-(0[1-9]|1[012])-(0[1-9]|[12][0-9]|3[01])[Tt]([01][0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9]|60)(\\.[0-9]+)?(([Zz])|([\\+|\\-]([01][0-9]|2[0-3]):[0-5][0-9]))$"
		}
		{
			## remove escape sequences
			gsub(/[^[:print:][:space:]]/,"")
			## remove control characters from the msg
			gsub(/[[:cntrl:]]/," ",$5)

			#normlize timestamp
			sub(/Z$/,"+00:00",$4)

			# remove leading spaces
			sub(/^[[:space:]]*/,"",$4)

			# add : to offset if missing
			if ( match($4,/[+-][0-9]{4}$/) ) {
				l = length($4)
				$4 = substr($4,1,l-4) substr($4,l-3,2) ":" substr($4,l-1,2)
			}

			## add seconds if missing
			if ( match( $4,/T[0-9]{2}:[0-9]{2}[+-]/ ) ) {
				$4 = substr($4,1,RSTART + RLENGTH -2) ":00" substr($4,RSTART + RLENGTH -1 )
			}

			# print if matching spec
			if ( NF == 5 && $4 ~ rfc3339 )
				print
		}
	'
}

gpg_verify () {
	gpg --status-fd=1 --no-verbose --quiet --batch --verify "$cache_dir/twtfiles/$1.txt" 2>/dev/null
}

collapse_mentions () {
	## TODO this *has* to be easier
	export follow_file nick twturl
	awk '
		function normalize_url (url,  host) {
			sub(/^http:/,"https:",url)

			if ( url ~ /^https:/ ) {
				host = url
				sub(/^https:\/\//,"", host)
				sub(/\/.*/,"", host)
				host = tolower(host)
				url = "https://" host substr(url,9+length(host))
			}
			return url
		}
		BEGIN {
			FS=" "
			while ( (getline < ENVIRON["follow_file"] ) > 0 ) {
				urls[normalize_url($2)] = $1
			}
			if ( ENVIRON["twturl"] && ENVIRON["nick"] )
				urls[ENVIRON["twturl"]] = ENVIRON["nick"]
			FS="\t"
			OFS=FS
		}
		{
			new_msg=""
			while ( match($5,/@<[^>]+>/) ) {
				new_msg = new_msg substr($5,1,RSTART-1)
				n = split(substr($5,RSTART+2,RLENGTH-3),fields," ")
				if ( n == 1 ) {
					url = fields[1]
				} else {
					url = fields[2]
				}

				url = normalize_url(url)

				if ( url in urls ) {
					new_msg = new_msg "@" urls[url]
				}
				else {
					new_msg = new_msg substr($5,RSTART,RLENGTH)
				}
				$5 = substr($5,RSTART+RLENGTH)
			}
			new_msg = new_msg $5
			$5=new_msg
			print
		}
	'
}

expand_mentions () {
	export follow_file nick twturl
	awk '
		BEGIN {
			FS=" "
			while ( (getline < ENVIRON["follow_file"] ) > 0 ) {
				nicks[$1]=$2
			}
			if ( ENVIRON["twturl"] )
				urls[ENVIRON["nick"]] = ENVIRON["twturl"]
			FS="\t"
			OFS=FS
		}
		{
			## TODO Bruteforcing, replace with something sane in the future
			for ( nick in nicks ) {
				gsub("@" nick, "@<" nick " " nicks[nick] ">", $2)
			}
			print
		}
	'
}

draft_to_twtfile () {
	[ -s "$draft_file" ] || return
	_fracsecs=0
	_timestamp_fmt=$(TZ=C date "+%Y-%m-%dT%H:%M:%S.%%06iZ")
	while read msg;do
		[ -n "$msg" ] || continue
		printf "$_timestamp_fmt\t%s\n" "$_fracsecs" "$msg"
		_fracsecs=$((  _fracsecs + 1 ))
	done < "$draft_file" | expand_mentions >> "$twtfile"
	publish
}

cleanup () {
	[ -e "$tempfile" ] && rm "$tempfile"
	[ -d "$tempdir" ] && rm -r "$tempdir"
}

post_tweet_hook () {
	:
}

process_stat_log () {
	while read file code redirects url;do
		nick="${file##*/}"
		nick="${nick%.txt}"

		case $code in
			4?? | 5?? )
				printf "%s: Feed returned %s.\n" \
					"$nick" "$code" >&2
				;;
		esac

		if [ "$redirects" -gt 0 ];then
			printf "%s: Canonical url at %s.\n" "$nick" "$url" >&2
		fi
	done
}

read_key () {
	_key=
	if [ -t 0 ];then
		if [ -z "$_stty" ];then
			_stty=$(stty -g)
		fi
		stty -echo -icanon min 1
		_key=$(dd bs=1 count=1 2>/dev/null)
		stty "$_stty"
	fi
}

getline () {
	_var=${2:-_line}
	if [ -t 0 ];then
		if [ -n "$BASH_VERSION" ];then
			read -ep "$1: " "$_var"
		else
			printf "%s: " "$1"
			IFS= read -r "$_var"
		fi
	fi
}

yesno () {
	printf "%s [yN] " "$1"
	read_key
	case $_key in
		y ) _rc=0 ;;
		* ) _rc=1 ;;
	esac
	printf "\n"
	return $_rc
}

################
## Subcommands #
################

update () {
	if ! [ -s "$follow_file" ] ;then
		die "You're not following anyone."
	fi

	if [ "$disclose_identity" -eq 1 ] && [ -n "$twturl" ];then
		user_agent="txtnish/$VERSION (+${twturl}; @$nick)"
	else
		user_agent="txtnish/$VERSION (+https://github.com/mdom/txtnish)"
	fi

	if [ -e "$twtfile" ];then
		ln -sf "$twtfile" "$cache_dir/twtfiles/$nick.txt"
	fi

	_no_args=$( args_for_curl | wc -l )

	sed -e 's/\s*#.*$//;/^\s*$/d' "$follow_file" | while read nick url;do
		rewrite_url
		args_for_curl "$nick" "$url"
	done | xargs -d "\n" -n$_no_args -P "$max_procs" curl $http_backend_args  | process_stat_log
	_http_rc=$?

	for logfile in "$log_dir"/http.log.*;do
		_nick="${logfile##*.}"
		awk -vnick="$_nick" '{print nick ": " $0 }' "$logfile" >&2
		rm "$logfile"
	done

	return $_http_rc
}

follow () {
	new_nick=$1
	new_url=$2

	[ -n "$new_nick" ] || usage "Required parameter NICK is missing."
	[ -n "$new_url"  ] || usage "Required parameter URL is missing."

	tempfile="$follow_file.$$"
	while read nick url;do
		if [ "$nick" = "$new_nick" ] || [ "$url" = "$new_url" ];then
			die "You're already following $nick at $url."
		fi
		printf "%s %s\n" "$nick" "$url";
	done < "$follow_file" > "$tempfile"
	printf "%s %s\n" "$new_nick" "$new_url" >> "$tempfile";
	mv "$tempfile" "$follow_file"
}

unfollow () {
	_url_or_nick=$1
	[ -n "$_url_or_nick" ] || usage "Required parameter NICK_OR_URL is missing."
	tempfile="$follow_file.$$"
	removed=
	while read nick url;do
		case $_url_or_nick in
			$nick | $url  ) removed=1 ;;
			* ) printf "%s %s\n" "$nick" "$url" ;;
		esac
	done < "$follow_file" > "$tempfile"
	if [ -n "$removed" ];then
		mv "$tempfile" "$follow_file"
	else
		die "You're not following $_url_or_nick."
	fi
}

following () {
	if [ -e "$follow_file" ];then
		cat "$follow_file"
	fi
}

tweet () {
	: >"$draft_file"

	if [ $# -eq 0 ];then
		if [ -t 0 ];then
			"$EDITOR" "$draft_file"
		else
			cat > "$draft_file"
		fi
	else
		printf "%s\n" "$@" > "$draft_file"
	fi
	draft_to_twtfile
}

reply () {
	use_pager=0
	use_color=0
	timeline "$@" | sed -e 's/^/# /' -e 's/^# $//' > "$draft_file"
	$editor "$draft_file"
	tempfile="$draft_file.$$"
	sed -e '/^# /d' -e '/^[[:space:]]*$/d' "$draft_file" > "$tempfile"
	mv "$tempfile" "$draft_file"
	draft_to_twtfile
}

timeline () {
	maybe_update;

	have_gpg=0
	if have_cmd gpg ;then
		have_gpg=1
	fi

	{ following ; printf "$nick $twturl\n"; } | \
		while read nick url ;do

		if [ $# -ne 0 ] && ! in_list "$*" "$nick";then
			continue
		fi

		[ -e "$cache_dir/twtfiles/$nick.txt" ] || continue

		prop=

		if [ "$have_gpg" -eq 1 ] && [ "$check_signatures" -eq 1 ];then
			gpg_status="$(gpg_verify "$nick")"
			case $gpg_status in
				*NODATA*   ) prop=gpg_unsigned ;;
				*NOPUBKEY* ) prop=gpg_signed ;;
				*VALIDSIG* ) prop=gpg_trusted ;;
				*          ) prop=gpg_unknown ;;
			esac
		fi

		case $url in
			https://* ) prop="${prop:+$prop,}tls" ;;
			http://* ) prop="${prop:+$prop,}notls" ;;
			ipfs://* | ipns://* ) prop=ipfs ;;
		esac

		prefix_columns "$nick" "$url" "$prop" < "$cache_dir/twtfiles/$nick.txt"
	done | display_tweets
}

publish () {
	if [ "$ipfs_publish" -eq 1 ] && have_cmd ipfs;then
		_ipfs_path="$twtfile"
		if [ "$ipfs_wrap_with_dir" -eq 1 ];then
			_ipfs_args=-w
		fi
		if [ "$ipfs_recursive" -eq 1 ];then
			_ipfs_args="$ipfs_args -r"
			_ipfs_path="${twtfile%/*}"
		fi
		if ipfs add -q $_ipfs_args "$_ipfs_path" > "$cache_dir/ipfs";then
			awk 'END{ print $1 }' "$cache_dir/ipfs" | xargs ipfs name publish
		fi
	fi
	if [ "$sign_twtfile" -eq 1 ];then
		if mkdir "$cache_dir/tmp.$$/";then
			tempdir="$cache_dir/tmp.$$/"
		else
			die "Can't create temporary dir $tempdir"
		fi
		if gpg --clearsign --output "$tempdir/${twtfile##*/}" "$twtfile";then
			twtfile="$tempdir/${twtfile##*/}"
		else
			die "Can't sign twtfile. Exiting";
		fi
	fi
	if [ -n "$scp_user" ] && [ -n "$scp_host" ];then
		scp "$twtfile" "$scp_user@$scp_host:${scp_remote_name:-${twtfile##*/}}"
	fi
	if [ -n "$ftp_user" ] && [ -n "$ftp_host" ];then
		if curl -Ss -nT "$twtfile" "ftp://$ftp_user@$ftp_host/${ftp_remote_name:-${twtfile##*/}}";then
			printf "Uploaded twtfile to %s\n" "ftp://$ftp_user@$ftp_host/${ftp_remote_name:-${twtfile##*/}}"
		fi
	fi
	post_tweet_hook
}

quickstart () {

	## Import settings from twtxt

	if [ -e "${XDG_CONFIG_HOME:-$HOME/.config}/twtxt/config" ];then
		if ! [ -e "$follow_file" ] && yesno "Import followings from twtxt?" ;then

			twtxt following | awk '{ print $1, $3 }' > "$follow_file"
		fi

		if ! [ -e "$config_file" ] && yesno "Import settings from twtxt?" ;then
			nick=$(twtxt config get nick)
			twturl=$(twtxt config get twturl)
			limit=$(twtxt config get limit_timeline)
			twtfile=$(twtxt config get twtfile)
			sort_order=$(twtxt config get sorting)

			{
				[ -n "$nick" ]       && printf "nick=%s\n"       "$nick"
				[ -n "$twturl" ]     && printf "twturl=%s\n"     "$twturl"
				[ -n "$limit" ]      && printf "limit=%s\n"      "$limit"
				[ -n "$twtfile" ]    && printf "twtfile=%s\n"    "$twtfile"
				[ -n "$sort_order" ] && printf "sort_order=%s\n" "$sort_order"

			} > "$config_file"
		fi
	fi

	## Quickstart for new users

	getline "Please enter your desired nick" nick
	getline "Please enter the desired location for your twtxt file" twtfile
	getline "Please enter the URL your twtxt file will be accessible from" twturl
	if yesno "Do you want to disclose your identity? Your nick and URL will be shared when making HTTP requests?";then
		disclose_identity=1
	fi

	if yesno "Import urls to follow we-are-twtx?" ;then
		curl -Ss https://raw.githubusercontent.com/mdom/we-are-twtxt/master/we-are-twtxt.txt | \
			xargs -n2 txtnish follow
	fi

	if yesno "Do you want to upload your twtfile with scp?";then
		getline "Please enter your scp username" scp_user
		getline "Pleaser enter scp host" scp_host
	fi

	if yesno "Do you want to upload your twtfile with ftp?";then
		getline "Please enter your ftp username" ftp_user
		getline "Pleaser enter ftp host" ftp_host
	fi

	if yesno "Write configuration to $config_file?";then
		if [ -e "$config_file" ];then
			mv "$config_file" "$config_file.bak"
			printf "Backup old config to %s.bak\n" "$config_file"
		fi
		cat <<-EOF > "$config_file"
			nick="$nick"
			twturl="$twturl"
			twtfile="$twtfile"
			disclose_identity="$disclose_identity"
EOF
		if [ -n "$scp_user" ] && [ -n "$scp_host" ];then
			cat <<-EOF >> "$config_file"
				scp_user="$scp_user"
				scp_host="$scp_host"
EOF
		fi
		if [ -n "$ftp_user" ] && [ -n "$ftp_host" ];then
			cat <<-EOF >> "$config_file"
				ftp_user="$ftp_user"
				ftp_host="$ftp_host"
EOF
		fi
		printf "Write new configuration to %s\n" "$config_file"
	fi


}

########################
# Command line parsing #
########################

call_mode () {
	while getopts ":$options" opt; do
		case $opt in
			l ) limit="$OPTARG" ;;
			h ) usage ;;
			p ) use_pager=1 ;;
			P ) use_pager=0 ;;
			u ) always_update=1 ;;
			U ) always_update=0 ;;
			a ) sort_order=ascending ;;
			d ) sort_order=descending ;;
			N ) max_procs="$OPTARG" ;;
			S ) filter_expr="$OPTARG" ;;
			B ) : ;;
			: ) usage "Option -$OPTARG requires an argument." ;;
			\? ) usage "Invalid option -$OPTARG." ;;
		esac
	done
	shift $(( OPTIND - 1 ))
	$mode "$@"
}

usage_main () {
	if [ -n "$1" ];then
		printf "%s\n" "$1" >&2;
		exec >&2
	fi
	cat <<-EOF
		usage: $program_name COMMAND [OPTIONS...]

		  Command:
		    tweet          Append a new tweet to your twtxt file.
		    timeline       Retrieve your personal timeline.
		    follow         Add a new source to your followings.
		    unfollow       Remove an existing source from your followings.
		    following      Return the list of sources you're following.
		    reply          Reply to tweets.
		    publish        Publish your twtfile.

		  Options:
		    -h      Print a help message and exit.
		    -v      Print version and exit.

EOF
	if [ -n "$1" ];then
		exit 1
	else
		exit 0
	fi
}

usage () {
	_err=$1
	if [ -n "$_err" ];then
		printf "%s\n" "$_err" >&2
		exec >&2
	fi

	cat <<-EOF
		usage: $program_name $mode [OPTIONS...]${arguments:+ $arguments}

		Synopsis:
		  $synopsis

		Options:
EOF

	while [ -n "$options" ] ;do
		c=${options%${options#?}}
		case $c in
			h ) printf "  -h     Print a help message and exit.\n" ;;
			l ) printf "  -l NUM Limit total numer of tweets shown.\n" ;;
			a ) printf "  -a     Sort timeline in ascending order.\n" ;;
			d ) printf "  -d     Sort timeline in descending order.\n" ;;
			p ) printf "  -p     Use pager to display content.\n" ;;
			P ) printf "  -P     Do not use pager to display content.\n" ;;
			u ) printf "  -u     Update sources.\n" ;;
			U ) printf "  -U     Do not update sources.\n" ;;
			N ) printf "  -N NUM Use NUM parallel download processes.\n" ;;
			S ) printf "  -S EXP Filter tweets\n" ;;
			c ) printf "  -c CFG Specify a custom config file location.\n" ;;
		esac
		options=${options#?}
	done

	## Always end usage with a empty line
	printf "\n"

	if [ -n "$_err" ];then
		exit 1
	else
		exit 0
	fi
}

#########
## Main #
#########

trap cleanup EXIT

create_dir "$config_dir"
create_dir "$cache_dir"
create_dir "$cache_dir/twtfiles"
create_dir "$log_dir"

if ! have_cmd curl;then
	die "curl has to be installed."
fi

while getopts ":c:hv" opt;do
	case $opt in
		v ) printf "%s\n" "$VERSION"; exit 0  ;;
		h ) usage_main ;;
		c )
			config_file="$OPTARG"
			if ! [ -e "$config_file" ];then
				die "Missing configuration file '$config_file'";
			fi
			;;
		: ) usage_main "Option -$OPTARG requires an argument." ;;
		\? ) usage_main "Invalid option -$OPTARG." ;;
	esac
done

shift $(( OPTIND - 1))

read_config

mode=$1

if [ -z "$mode" ];then
	usage_main
	exit 1
fi

shift

case $mode in
	update )
		synopsis="Fetching new twtfiles from all your sources."
		options="hN:"
		call_mode "$@"
		;;
	follow )
		synopsis="Add a new source to your followings."
		arguments="NICK SOURCE"
		options="h"
		call_mode "$@"
		;;
	unfollow )
		synopsis="Remove an existing source from your followings."
		arguments="NICK"
		options="h"
		call_mode "$@"
		;;
	following )
		synopsis="Return the list of sources you're following."
		options="h"
		call_mode "$@"
		;;
	timeline | view )
		synopsis="Display timeline."
		arguments="[NICK...]"
		options="hl:adpPuUN:S:"
		call_mode "$@"
		;;
	reply )
		synopsis="Reply to tweets."
		arguments="[NICK]"
		options="hl:aduUN:S:"
		call_mode "$@"
		;;
	publish )
		synopsis="Publish your twtfile."
		options="h"
		call_mode "$@"
		;;
	tweet )
		synopsis="Append a new tweet to your twtxt file."
		arguments="[TWEET...]"
		options="h"
		call_mode "$@"
		;;
	quickstart )
		synopsis="Import settings from twtxt."
		options="h"
		call_mode "$@"
		;;
	* ) printf "Unknown mode %s.\n" "$mode" >&2; usage_main; exit 1;;
esac

exit 0
