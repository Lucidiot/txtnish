#!/bin/sh

TAB=$(printf "\t")
ESC="\033"
limit=20
formatter="fmt"
use_pager=1
use_color=1
twtfile=~/twtxt.txt
user_agent="txtnish/0.1 (+https://github.com/mdom/txtnish)"

## Colors
csi="${ESC}["
reset="${csi}0m"
black=0
red=1
green=2
yellow=3
blue=4
magenta=5
cyan=6
white=7

fg=3
bg=4

color_nick=$yellow
color_time=$blue

die () {
	printf "$0: %s\n" "$1"
	exit "${2:-1}"
}

create_dir () {
	[ -d "$1" ] || mkdir -p "$1"
}

read_config () {
	if [ -e ~/.config/txtnish/config ];then
		. ~/.config/txtnish/config
	fi
}

update () {
	urls | xargs -n1 -P20 wget --user-agent="$user_agent" --timestamping -P ~/.cache/txtnish/ -x -q
}

urls () {
	[ -f ~/.config/txtnish/following ] || return
	## i'm not using awk here as the number of urls is usually pretty short.
	while read _ url;do
		printf "%s\n" "$url"
	done < ~/.config/txtnish/following
}

format_msg () {
	while read nick url ts msg;do
		if [ "$use_color" -eq 1 ];then
			nick="${csi}${fg}${color_nick}m${nick}${reset}"
			ts="${csi}${fg}${color_time}m${ts}${reset}"
		fi
		printf "* %b (%b)\n" "$nick" "$ts"
		if type "$formatter" >/dev/null 2>&1;then
			printf "%s\n" "$msg" | $formatter
		else
			printf "%s\n" "$msg"
		fi
		printf "\n"
	done
}

limit () {
	if [ -n "$limit" ];then
		sed "${limit}q"
	else
		cat
	fi
}

sort_tweets () {
	awk -F"$TAB" '
		BEGIN { OFS=FS; OFMT="%f" }
		$3 && $4 {
			ts=$3
			sub(/Z$/,"+00:00",ts)
			no_fields = split(ts,ta,/[T:+.-]/)
			seconds = (ta[1]-1970)*31557600 + ta[2] * 2628000 + ta[3] * 86400 + ta[4] * 3600 + ta[5] * 60 + ta[6]
			if ( no_fields == 9 ) {
				offset = ta[8] * 3600 + ta[9] * 60
				fracsecs=ta[7]
			}
			else {
				offset = ta[7] * 3600 + ta[8] * 60
				fracsecs=0
			}
			mod = substr(ts,length(ts)-5,1)
			if ( mod == "+" ) {
				seconds += offset
			} else {
				seconds -= offset
			}
			print seconds, fracsecs, $0
		}	
	' | sort -nr -k1,2 | cut -d "$TAB" -f 3-
}

pager () {
	if [ "$use_pager" -eq 1 ];then
		${PAGER:-less}
	else
		cat
	fi
}

url_to_file () {
	_twtfile=~/.cache/txtnish/${1#*://}
	_twtfile=${_twtfile%%#*}
	if [ -d "$_twtfile" ] && [ -e "$_twtfile/index.html" ];then
		_twtfile="$_twtfile/index.html"
	fi
	if ! [ -e "$_twtfile" ];then
		_twtfile=
	fi
	_url_to_file="$_twtfile"
}

timeline () {
	update;
	while read nick url;do
		url_to_file "$url"
		[ -n "$_url_to_file" ] || continue
		add_nick_url "$nick" "$url" "$_url_to_file"
	done < ~/.config/txtnish/following | display_tweets
}

add_nick_url () {
	_nick=$1
	_url=$2
	_twtfile=$3
	awk -vnick="$_nick" -vurl="$_url" 'BEGIN{OFS="\t"}{print nick,url,$0}' < "$_twtfile"
}

display_tweets () {
	sort_tweets | limit | collapse_mentions | format_msg | pager
}

collapse_mentions () {
	## TODO this *has* to be easier
	awk -v following=$HOME/.config/txtnish/following '
		BEGIN {
			FS=" "
			while ( (getline < following) > 0 ) {
				urls[$2]=$1
			}
			FS="\t"
			OFS=FS
		}
		{
			new_msg=""
			while ( match($4,/@<[^>]+>/) ) {
				new_msg = new_msg substr($4,1,RSTART-1)
				n = split(substr($4,RSTART+2,RLENGTH-3),fields," ")
				if ( n == 1 ) {
					url = fields[1]
				} else {
					url = fields[2]
				}
				if ( url in urls ) {
					new_msg = new_msg "@" urls[url]
				}
				else {
					new_msg = new_msg substr($4,RSTART,RLENGTH)
				}
				$4 = substr($4,RSTART+RLENGTH)
			}
			new_msg = new_msg $4
			$4=new_msg
			print
		}
	'
}

expand_mentions () {
	awk -v following=$HOME/.config/txtnish/following '
		BEGIN {
			FS=" "
			while ( (getline < following) > 0 ) {
				nicks[$1]=$2
			}
			FS="\t"
			OFS=FS
		}
		{
			## TODO Bruteforcing, replace with something sane in the future
			for ( nick in nicks ) {
				gsub("@" nick, "@<" nick " " nicks[nick] ">", $2)
			}
			print
		}
	'
}

view () {
	## TODO update only the single url
	update;
	_nick=$1
	while read nick url;do
		if [ "$nick" = "$_nick" ] ;then
			url_to_file "$url"
			[ -n "$_url_to_file" ] || continue
			add_nick_url "$nick" "$url" "$_url_to_file" | display_tweets
			return
		fi
	done < "$HOME/.config/txtnish/following"
}

follow () {
	new_nick=$1
	new_url=$2
	tempfile="$HOME/.config/txtnish/following.$$"
	while read nick url;do
		if [ "$nick" = "$new_nick" ] || [ "$url" = "$new_url" ];then
			die "You're already following $nick at $url."
		fi
		printf "$nick $url\n";
	done < "$HOME/.config/txtnish/following" > "$tempfile"
	printf "$new_nick $new_url\n" >> "$tempfile";
	mv "$tempfile" "$HOME/.config/txtnish/following"
}

unfollow () {
	old_nick=$1
	tempfile="$HOME/.config/txtnish/following.$$"
	removed=
	while read nick url;do
		if [ "$nick" = "$old_nick" ];then
			removed=1
		else
			printf "$nick $url\n";
		fi
	done < "$HOME/.config/txtnish/following" > "$tempfile"
	mv "$tempfile" "$HOME/.config/txtnish/following"
	if [ -z "$removed" ];then
		die "You're not following $old_nick."
	fi
}

following () {
	cat "$HOME/.config/txtnish/following"
}

tweet () {
	_draft="$HOME/.config/txtnish/draft"
	: >"$_draft"

	if [ $# -eq 0 ];then
		if [ -t 0 ];then
			"$EDITOR" "$_draft"
		else
			cat > "$_draft"
		fi
	else
		printf "%s\n" "$@" > "$_draft"
	fi

	_fracsecs=0
	_timestamp=$(TZ=C date "+%Y-%m-%dT%H:%M:%S.%%06iZ")

	while read msg;do
		[ -n "$msg" ] || continue
		printf "$_timestamp\t%s\n" "$_fracsecs" "$msg"
		_fracsecs=$(( $_fracsecs + 1 ))
	done < "$_draft" | expand_mentions >> "$twtfile"
}

cleanup () {
	[ -e "$tempfile" ] && rm "$tempfile"
}

trap cleanup EXIT

create_dir "$HOME/.config/txtnish"
create_dir "$HOME/.cache/txtnish"

mode=$1
shift

read_config

case $mode in
	update ) update ;;
	follow ) follow "$@" ;;
	unfollow ) unfollow "$@" ;;
	following ) following ;;
	timeline ) timeline ;;
	tweet ) tweet "$@" ;;
	view ) view "$@" ;;
	* ) die "Unknown mode $mode." ;;
esac

exit 0
