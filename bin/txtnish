#!/bin/sh

TAB="	"
limit=20
formatter="fmt"

die () {
	printf "$0: %s\n" "$1"
	exit "${2:-1}"
}

create_dir () {
	[ -d "$1" ] || mkdir -p "$1"
}

update () {
	create_dir ~/.cache/txtnish/
	urls | xargs -n1 -P20 wget --timestamping -P ~/.cache/txtnish/ -x -q
}

urls () {
	[ -f ~/.config/txtnish/following ] || return
	## i'm not using awk here as the number of urls is usually pretty short.
	while read _ url;do
		printf "%s\n" "$url"
	done < ~/.config/txtnish/following
}

format_msg () {
	while read _ _ nick url ts msg;do
		printf "* %s (%s)\n" "$nick" "$ts"
		if type "$formatter" >/dev/null 2>&1;then
			printf "%s\n" "$msg" | $formatter
		else
			printf "%s\n" "$msg"
		fi
		printf "\n"
	done
}

normalize_time () {
	awk -F"$TAB" '
		$3 && $4 {
			sub(/Z$/,"+00:00",$3)
			match($3,/\.[0-9]+/)
			if ( RSTART ) {
				secfrac=substr($3,RSTART+1,RLENGTH-1)
				fracless=$3
				sub(/\.[0-9]+/,"",fracless)
			}
			else {
				fracless=$3
				secfrac=0
			}
			OFS="	"
			print fracless, secfrac, $0
		}	
	'
}

limit () {
	if [ -n "$limit" ];then
		sed "${limit}q"
	else
		cat
	fi
}

sort_tweets () {
	# TODO timezones are not sorted in the right order!
	sort -r -k1,1 -k2,2
}

timeline () {
	update;
	while read nick url;do
		twtfile=~/.cache/txtnish/${url#*://}
		twtfile=${twtfile%%#*}
		if [ -d "$twtfile" ] && [ -e "$twtfile/index.html" ];then
			twtfile="$twtfile/index.html"
		fi
		[ -e "$twtfile" ] || continue

		awk -vnick="$nick" -vurl="$url" 'BEGIN{OFS="	"}{print nick,url,$0}' < "$twtfile"
	done < ~/.config/txtnish/following | normalize_time | sort_tweets | limit | format_msg
}


mode=$1
shift

case $mode in
	update ) update ;;
	timeline ) timeline ;;
	* ) die "Unknown mode $mode." ;;
esac

exit 0
